#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int offset = 0x000000fc;
int sectionCount = 0;
int exedataSz;
int asmSz;
char *asm;
int asmOffset;
char *exedata;

FILE *file;

char header[28] = {
	0x4d,0x5a,0x00,0x00,     									//MZ
	0x50,0x45,0x00,0x00,      									//beginning of file header
	0x4c,0x01,													//machine type
	0x01,0x00,													//number of sections 
	0xff,0xff,0xff,0xff,										//buildDate
	0x00,0x00,0x00,0x00,										
	0x00,0x00,0x00,0x00,										
	0xe0,0x00,													//optional header size
	0x03,0x01
};

char optHeader[] = {						
	0x0b,0x01,										//executable flags
	0x08,
	0x00,
	0x05,0x00,0x00,0x00,							//size of the code
	0x00,0x00,0x00,0x00,							//size of init data
	0x00,0x00,0x00,0x00,							//size of uninit data
	0x24,0x01,0x00,0x00,							//adress waar assembly begint
	0x24,0x01,0x00,0x00,							//base of code
	0x28,0x01,0x00,0x00,							//base of data
	0x00,0x00,0x40,0x00,							//image base ???
	0x04,0x00,0x00,0x00,							//section alignment
	0x04,0x00,0x00,0x00,							//file alignment
	0x04,0x00,										//major OS version
	0x00,0x00,										//minor OS version
	0x00,0x00,										//Major image version
	0x00,0x00,										//Minor Image version
	0x04,0x00,										//Major Subsystem Version
	0x00,0x00,										//Minor Subsystem Version
	0x00,0x00,0x00,0x00,							//win32 version value
	0x29,0x01,0x00,0x00,                         	//groote van .exe file
	0x24,0x01,0x00,0x00,							//groote van de headers
	0x00,0x00,0x00,0x00,							//checksum
	0x03,0x00,										//subSystem
	0x00,0x40,										//dll caracteristics
	0x00,0x00,0x01,0x00,							
	0x00,0x01,0x00,0x00,
	0x00,0x00,0x01,0x00,
	0x00,0x01,0x00,0x00,
	0x00,0x00,0x00,0x00,
	0x10,0x00,0x00,0x00};

char linking[] = {
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,        //export dir							
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//import dir
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//resource dir
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//exeption dir
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//security dir
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//base relocation dir
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//debug dir
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//architecure specific data
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//rva of gp
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//tls dir
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//load config dir
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//boudn import dir
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//import address table
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//delay import descriptors
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		//com runtime discriptor
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00      	//reserverd
	
};

void createSection(int flags,int entrypoint,int size){
	char name[8] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
	switch(flags){
		case 0x60000020:
			memcpy(name,".text",5);
			optHeader[4] = size;
			optHeader[5] = size >> 8;
			optHeader[16] = entrypoint;
			optHeader[17] = entrypoint >> 8; 
			optHeader[20] = entrypoint;
			optHeader[21] = entrypoint >> 8;
			asm = calloc(size,1);
			asmSz = size;
			break;
		case 0x40000040:
			memcpy(name,".data",5);
			optHeader[8] = size;
			optHeader[9] = size >> 8;
			optHeader[24] = entrypoint;
			optHeader[25] = entrypoint >> 8;
			exedata = calloc(size,1);
			exedataSz = size;
			break;
		default:
			memcpy(name,".unknown",8);
	}
	fseek(file,offset,SEEK_SET);
	fwrite(name,8,1,file);
	fwrite(&size,1,4,file);
	fwrite(&offset,1,4,file);
	fwrite(&size,1,4,file);
	fwrite(&offset,1,4,file);
	fseek(file,offset + 36,SEEK_SET);
	fwrite(&flags,1,4,file);
	offset += 0x28;
	sectionCount++;
}

void createExe(char *name){
	file = fopen(name,"w");
}

void closeExe(){
	header[10] = sectionCount;
	optHeader[60] = offset;
	optHeader[61] = offset >> 8;
	optHeader[16] = offset;
	optHeader[17] = offset >> 8;
	int headerSizes = offset + asmSz + exedataSz;
	optHeader[56] = headerSizes;
	optHeader[57] = headerSizes >> 8;
	fseek(file,0,SEEK_SET);
	fwrite(header,sizeof(header),1,file);
	fwrite(optHeader,sizeof(optHeader),1,file);
	fwrite(linking,sizeof(linking),1,file);
	fseek(file,offset,SEEK_SET);
	fwrite(asm,asmSz,1,file);
	fwrite(exedata,exedataSz,1,file);
	fclose(file);
}

void addAsm(char val){
	asm[asmOffset] = val;
	asmOffset++;
}

void main(){
	createExe("gert.exe");
	createSection(0x60000020,0x0000014c,20);
	createSection(0x40000040,0x00000160,20);
	addAsm(0x6a);
	addAsm(0x10);
	addAsm(0xeb);
	addAsm(0xfc);
	closeExe();
}
